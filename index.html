<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="theme-color" content="#b76e86">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <title>3 Marias Moda Feminina (V6.1)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ... CSS BASE IGUAL ... */
        :root { --primary-color: #b76e86; --accent-color: #DAA520; --silver-color: #C0C0C0; --text-color: #333; --light-text: #666; --bg-color: #FFFFFF; --border-color: #f0f0f0; --whatsapp-green: #28a745; }
        @keyframes shimmer-glow { 0% { box-shadow: 0 0 5px var(--accent-color); } 50% { box-shadow: 0 0 10px var(--silver-color); } 100% { box-shadow: 0 0 5px var(--accent-color); } }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
        
        header { background-color: var(--bg-color); color: var(--text-color); padding: 0.5rem 1rem; text-align: center; border-bottom: 1px solid var(--border-color); position: relative; }
        
        /* Sino (Inbox) - Mantido */
        #notification-bell { position: absolute; top: 20px; right: 20px; font-size: 24px; color: var(--primary-color); cursor: pointer; z-index: 100; }
        
        .header-logo { max-width: 250px; width: 100%; height: auto; object-fit: contain; margin: 0 auto; display: block; cursor: pointer; }
        header p { font-size: 1em; color: var(--light-text); margin: 2px 0 0 0; line-height: 1.4; }
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        
        /* Busca */
        #search-container { position: relative; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
        #search-input { width: 100%; padding: 12px 40px 12px 20px; border: 1px solid #ddd; border-radius: 25px; font-size: 1em; outline: none; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
        #search-input:focus { border-color: var(--primary-color); box-shadow: 0 0 8px rgba(183, 110, 134, 0.2); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        #search-no-results { display: none; text-align: center; color: var(--light-text); margin-top: 20px; font-style: italic; }

        /* Filtros */
        #secao-filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .secao-button { background-color: #f5f5f5; color: var(--text-color); padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .secao-button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 600; }
        #controls { display: flex; flex-direction: row; gap: 10px; margin-bottom: 10px; padding: 10px; background-color: var(--bg-color); border-radius: 8px; justify-content: center; }
        .filter-button { background-color: var(--bg-color); color: var(--text-color); padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; box-sizing: border-box; animation: shimmer-glow 3s ease-in-out infinite; }
        .filter-button.active { background-color: var(--accent-color); color: var(--text-color); border-color: var(--accent-color); animation: none; }
        #filter-details { text-align: center; color: var(--light-text); font-size: 0.9em; margin: 0 auto 20px auto; padding: 0 15px; max-width: 500px; line-height: 1.5; white-space: pre-line; }
        .section-title { font-size: 1.5em; color: var(--text-color); margin-bottom: 20px; font-weight: 600; text-align: center; border-bottom: none; }
        
        /* Grid */
        #products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .product-card { background-color: white; border-radius: 8px; box-shadow: none; border: 1px solid var(--border-color); overflow: hidden; text-decoration: none; color: var(--text-color); transition: transform 0.2s; position: relative; }
        .product-card:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .product-image-container { width: 100%; padding-top: 150%; position: relative; background-color: #f0f0f0; }
        .product-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 15px; text-align: left; }
        .product-name { font-size: 1em; font-weight: 600; margin: 0 0 5px 0; }
        .product-price { font-size: 1.1em; font-weight: 700; color: var(--primary-color); margin: 0 0 15px 0; }
        .details-button { display: inline-block; background-color: var(--primary-color); color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; text-decoration: none; transition: background-color 0.3s; font-size: 0.9em; width: 100%; box-sizing: border-box; text-align: center; }
        .details-button:hover { background-color: #a15a70; }
        .badge { position: absolute; top: 10px; left: 10px; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: bold; color: white; z-index: 10; }
        .badge-novo { background-color: var(--accent-color); color: #333; }
        .badge-destaque { background-color: var(--whatsapp-green); }
        .badge-esgotado { background-color: rgba(100, 100, 100, 0.9); color: white; top: 10px; right: 10px; left: auto; }
        
        footer { text-align: center; padding: 20px; margin-top: 40px; color: var(--light-text); font-size: 0.9em; border-top: 1px solid var(--border-color); }
        
        /* Carrinho */
        #cart-icon { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: var(--whatsapp-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 1000; transition: transform 0.2s; text-decoration: none; }
        #cart-icon:hover { transform: scale(1.1); }
        #cart-count { position: absolute; top: -5px; right: -5px; background-color: var(--primary-color); color: white; border-radius: 50%; padding: 2px 7px; font-size: 14px; font-weight: bold; border: 2px solid white; display: none; }

        /* BotÃ£o Instalar App */
        #install-app-btn { display: none; width: 100%; background-color: var(--accent-color); color: #333; font-weight: bold; text-align: center; padding: 12px; border: none; cursor: pointer; margin-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Aviso iOS */
        #ios-install-banner { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(255, 255, 255, 0.98); border-top: 1px solid #ccc; padding: 20px 15px; text-align: center; z-index: 2000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        #ios-install-banner p { margin: 0; font-size: 0.9em; color: #333; line-height: 1.5; }
        #ios-install-banner span { font-weight: bold; color: var(--primary-color); }
        #close-ios-banner { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; line-height: 1; }
        .ios-share-icon { display: inline-block; vertical-align: middle; margin: 0 3px; font-size: 1.2em; color: #007AFF; }

        /* ðŸš¨ NOVO: Modal de Pedir PermissÃ£o (AutomÃ¡tico) */
        #push-permission-modal {
            display: none; /* Aparece via JS */
            position: fixed;
            z-index: 3000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center; align-items: center;
        }
        .push-modal-content {
            background-color: #fff;
            width: 85%; max-width: 350px;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .push-icon { font-size: 40px; color: var(--accent-color); margin-bottom: 15px; }
        .push-title { font-size: 1.2em; font-weight: bold; color: var(--text-color); margin-bottom: 10px; }
        .push-text { font-size: 0.95em; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .push-btn-allow {
            background-color: var(--primary-color); color: white;
            border: none; padding: 12px 20px; border-radius: 25px;
            font-weight: bold; font-size: 1em; width: 100%; cursor: pointer;
            margin-bottom: 10px; transition: 0.3s;
        }
        .push-btn-deny {
            background-color: transparent; color: #999;
            border: none; font-size: 0.9em; cursor: pointer; text-decoration: underline;
        }

        /* Modal Inbox */
        #inbox-modal { display: none; position: fixed; z-index: 2500; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: start; padding-top: 60px; }
        .inbox-content { background-color: #fff; width: 90%; max-width: 400px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden; }
        .inbox-header { background-color: var(--primary-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        #inbox-close { cursor: pointer; font-size: 20px; }
        #inbox-list { max-height: 60vh; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .inbox-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .inbox-item:hover { background-color: #f9f9f9; }
        .inbox-title { font-weight: bold; margin-bottom: 5px; color: #333; }
        .inbox-body { font-size: 0.9em; color: #666; margin-bottom: 8px; }
        .inbox-date { font-size: 0.75em; color: #aaa; text-align: right; }
        .inbox-empty { padding: 20px; text-align: center; color: #999; font-style: italic; }
        
        @media (min-width: 768px) { #products-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); } }
    </style>
</head>
<body>
    
    <button id="install-app-btn">ðŸ“² Instalar Aplicativo 3 Marias</button>
    
    <div id="push-permission-modal">
        <div class="push-modal-content">
            <div class="push-icon">ðŸ””</div>
            <div class="push-title">Ativar NotificaÃ§Ãµes?</div>
            <div class="push-text">Receba avisos sobre reposiÃ§Ãµes, novidades e cupons exclusivos da 3 Marias direto no seu celular.</div>
            <button class="push-btn-allow" id="allow-push-btn">Sim, eu quero!</button>
            <button class="push-btn-deny" id="deny-push-btn">Agora nÃ£o</button>
        </div>
    </div>
    
    <header id="main-header">
        <div id="notification-bell"><i class="fas fa-bell"></i></div>
        <h1>3 MARIAS MODA FEMININA</h1> 
        <p>O melhor do Brasil,<br>agora ao seu alcance no JapÃ£o.</p>
    </header>

    <div id="inbox-modal">
        <div class="inbox-content">
            <div class="inbox-header"><span>Novidades & Avisos</span><span id="inbox-close">&times;</span></div>
            <ul id="inbox-list"></ul>
        </div>
    </div>

    <main>
        <div id="search-container"><input type="text" id="search-input" placeholder="Buscar produto (ex: SutiÃ£, Vermelho)..."><i class="fas fa-search search-icon"></i></div>
        <div id="secao-filters"><button class="secao-button active" data-secao="todos">Todas</button><button class="secao-button" data-secao="calcinhas">Calcinhas</button><button class="secao-button" data-secao="sutias">SutiÃ£s</button><button class="secao-button" data-secao="conjuntos">Conjuntos</button><button class="secao-button" data-secao="body">Body</button><button class="secao-button" data-secao="perfumaria">Perfumaria</button><button class="secao-button" data-secao="cremes">Cremes</button><button class="secao-button" data-secao="variados">Variados</button></div>
        <div id="controls"><button class="filter-button active" data-filter="pronta-entrega">Pronta Entrega</button><button class="filter-button" data-filter="sob-encomenda">Sob Encomenda</button></div>
        <div id="filter-details"></div>
        <h2 id="collection-title" class="section-title">Carregando...</h2>
        <div id="products-grid"></div>
        <div id="loading-message">Carregando produtos...</div>
        <div id="error-message" style="display: none;"></div>
        <p id="search-no-results">Nenhum produto encontrado com esse nome.</p>
    </main>

    <footer><p>Â© 2025 3Marias. Todos os direitos reservados.</p></footer>
    <a id="cart-icon" href="carrinho.html"><i class="fas fa-shopping-bag"></i><span id="cart-count">0</span></a>
    <div id="ios-install-banner"><span id="close-ios-banner">&times;</span><p>Para instalar o App, toque em <strong>Compartilhar</strong> <i class="fas fa-share-square ios-share-icon"></i> e depois em <strong>Adicionar Ã  Tela de InÃ­cio</strong> <i class="fas fa-plus-square"></i>.</p></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDtQK3dZKTqoTkXkwTUM2vkviVD41UoHpI", authDomain: "loja3marias-50204.firebaseapp.com", projectId: "loja3marias-50204", storageBucket: "loja3marias-50204.firebasestorage.app", messagingSenderId: "405330133487", appId: "1:405330133487:web:606de41211df52245f761a", measurementId: "G-TK877V6P0S" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging; try { if (firebase.messaging.isSupported()) { messaging = firebase.messaging(); } } catch (e) { console.log("Messaging nÃ£o suportado"); }

        const grid=document.getElementById('products-grid'), loadingMsg=document.getElementById('loading-message'), errorMsg=document.getElementById('error-message'), filterButtons=document.querySelectorAll('.filter-button'), secaoButtons=document.querySelectorAll('.secao-button'), collectionTitle=document.getElementById('collection-title'), cartCountEl=document.getElementById('cart-count'), headerEl=document.getElementById('main-header'), filterDetails=document.getElementById('filter-details'), searchInput=document.getElementById('search-input'), searchNoResults=document.getElementById('search-no-results'), cartIcon=document.getElementById('cart-icon');
        let currentFilter='pronta-entrega', currentSecao='todos';
        const filterHelpTexts={'pronta-entrega':".DisponÃ­vel para retirar em Toyohashi\ne regiÃ£o .",'sob-encomenda':".DisponÃ­vel para retirar em Toyohashi na prÃ³xima quinta-feira apÃ³s o pedido.\n. Receba por correio entre 3-5 dias , pedido mÃ­nimo Â¥10.000"};
        
        if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
        let deferredPrompt; const installBtn=document.getElementById('install-app-btn');
        window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='block'});
        installBtn.addEventListener('click',()=>{installBtn.style.display='none';if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null})}});
        const isIos=()=>{const u=window.navigator.userAgent.toLowerCase();return /iphone|ipad|ipod/.test(u)};
        const isInStandaloneMode=()=>('standalone' in window.navigator)&&(window.navigator.standalone);
        if(isIos()&&!isInStandaloneMode()){const b=document.getElementById('ios-install-banner');b.style.display='block';if(cartIcon)cartIcon.style.bottom='100px';document.getElementById('close-ios-banner').addEventListener('click',()=>{b.style.display='none';if(cartIcon)cartIcon.style.bottom='20px'})}

        // Inbox
        const bell=document.getElementById('notification-bell'), inboxModal=document.getElementById('inbox-modal'), inboxList=document.getElementById('inbox-list'), inboxClose=document.getElementById('inbox-close');
        bell.addEventListener('click',async()=>{
            inboxModal.style.display='flex'; inboxList.innerHTML='<li class="inbox-empty">Carregando...</li>';
            try{
                const snap=await db.collection('site_messages').orderBy('createdAt','desc').limit(10).get();
                inboxList.innerHTML=''; if(snap.empty){inboxList.innerHTML='<li class="inbox-empty">Nenhuma novidade.</li>';return}
                snap.forEach(d=>{
                    const m=d.data(), dt=m.createdAt?m.createdAt.toDate().toLocaleDateString('pt-BR'):'';
                    const li=document.createElement('li'); li.className='inbox-item';
                    li.innerHTML=`<div class="inbox-title">${m.title}</div><div class="inbox-body">${m.body}</div><div class="inbox-date">${dt}</div>`;
                    if(m.link) li.addEventListener('click',()=>window.location.href=m.link);
                    inboxList.appendChild(li);
                });
            }catch(e){inboxList.innerHTML='<li class="inbox-empty">Erro ao carregar.</li>'}
        });
        inboxClose.addEventListener('click',()=>inboxModal.style.display='none'); inboxModal.addEventListener('click',(e)=>{if(e.target===inboxModal)inboxModal.style.display='none'});

        // ðŸš¨ LÃ“GICA DO MODAL AUTOMÃTICO DE PUSH ðŸš¨
        const pushModal = document.getElementById('push-permission-modal');
        const allowBtn = document.getElementById('allow-push-btn');
        const denyBtn = document.getElementById('deny-push-btn');

        async function checkPushPermission() {
            if (!messaging) return;
            // SÃ³ mostra se o status for 'default' (nunca perguntou antes)
            if (Notification.permission === 'default') {
                // Pequeno delay para nÃ£o ser agressivo demais ao carregar
                setTimeout(() => {
                    pushModal.style.display = 'flex';
                }, 2000);
            }
        }

        if (allowBtn) {
            allowBtn.addEventListener('click', async () => {
                pushModal.style.display = 'none'; // Fecha o modal customizado
                try {
                    // Chama o prompt nativo do navegador
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        await saveToken();
                        alert("Obrigado! VocÃª receberÃ¡ nossas ofertas. ðŸ””");
                    } else {
                        // Se negar no nativo, nÃ£o fazemos nada (o navegador bloqueia)
                    }
                } catch (error) {
                    console.error("Erro:", error);
                }
            });
        }

        if (denyBtn) {
            denyBtn.addEventListener('click', () => {
                pushModal.style.display = 'none';
                // Opcional: Salvar no localStorage para nÃ£o perguntar de novo por X dias
            });
        }

        async function saveToken(){ try{ const t=await messaging.getToken({vapidKey:'BInIXSUQdmOW6xyauTrERRsEgA0QtupR2fmDrhIckU-QA2sLBCJQnKsJk1eK40esRAW3EGYWQMz1WOnVHaIsPPA'}); if(t)await db.collection('push_tokens').doc(t).set({token:t,createdAt:firebase.firestore.FieldValue.serverTimestamp()}) }catch(e){console.log(e)}}

        let lc=0, lt=null; headerEl.addEventListener('click',(e)=>{if(e.target.closest('.header-logo')){lc++;if(lt)clearTimeout(lt);if(lc===3){window.location.href='admin.html';lc=0}else{lt=setTimeout(()=>{lc=0},1500)}}});
        function getCart(){return JSON.parse(localStorage.getItem('whatsappCart'))||{items:{}}}
        function updateCartIcon(){const c=getCart();let q=0;Object.values(c.items).forEach(i=>q+=i.quantity);if(q>0){cartCountEl.textContent=q;cartCountEl.style.display='flex'}else{cartCountEl.style.display='none'}}
        
        async function fetchProducts(){
            loadingMsg.style.display='block'; errorMsg.style.display='none'; grid.innerHTML=''; searchNoResults.style.display='none';
            const st=document.querySelector(`.secao-button[data-secao="${currentSecao}"]`).textContent;
            const ft=document.querySelector(`.filter-button[data-filter="${currentFilter}"]`).textContent;
            collectionTitle.textContent=`${st} | ${ft}`; filterDetails.textContent=filterHelpTexts[currentFilter];
            try{
                let q=db.collection("products"); if(currentSecao!=='todos')q=q.where("secao","==",currentSecao);
                q=q.where("source","==",currentFilter).orderBy("createdAt","desc");
                const snap=await q.get();
                if(snap.empty){loadingMsg.style.display='none';grid.innerHTML='<p style="text-align:center;grid-column:1/-1">Nenhum produto encontrado.</p>';return}
                snap.forEach(d=>{
                    const p=d.data(), id=d.id, pf=(p.price||0).toLocaleString('ja-JP');
                    let b=''; if(p.isFeatured==='novo')b='<span class="badge badge-novo">âœ¨ Novidade</span>';else if(p.isFeatured==='destaque')b='<span class="badge badge-destaque">ðŸ”¥ Destaque</span>';
                    let sb=''; if((p.estoqueTotal||0)<=0 && p.source==='pronta-entrega') sb='<span class="badge badge-esgotado">Esgotado</span>';
                    const c=document.createElement('a'); c.href=`detalhes.html?id=${id}`; c.className='product-card';
                    c.innerHTML=`${b}${sb}<div class="product-image-container"><img src="${p.imageUrl||'https://via.placeholder.com/400'}" class="product-image"></div><div class="product-info"><h3 class="product-name">${p.name}</h3><p class="product-price">Â¥${pf}</p><span class="details-button">Ver Detalhes</span></div>`;
                    grid.appendChild(c);
                });
                loadingMsg.style.display='none'; if(searchInput.value.trim()) filterProductsBySearch(searchInput.value.trim());
            }catch(e){loadingMsg.style.display='none';errorMsg.style.display='block';errorMsg.innerHTML='Erro ao carregar produtos.';}
        }
        
        searchInput.addEventListener('input',(e)=>filterProductsBySearch(e.target.value.trim()));
        function filterProductsBySearch(t){const c=document.querySelectorAll('.product-card'), l=t.toLowerCase(); let h=false; c.forEach(card=>{if(card.querySelector('.product-name').textContent.toLowerCase().includes(l)){card.style.display='block';h=true}else{card.style.display='none'}}); searchNoResults.style.display=(!h&&t!=='')?'block':'none'}
        async function fetchSiteConfig(){try{const d=await db.collection("configuracoes").doc("siteInfo").get();if(d.exists&&d.data().logoUrl)headerEl.innerHTML=`<img src="${d.data().logoUrl}" class="header-logo"><p>O melhor do Brasil,<br>agora ao seu alcance no JapÃ£o.</p>`}catch(e){}}
        secaoButtons.forEach(b=>b.addEventListener('click',()=>{secaoButtons.forEach(bt=>bt.classList.remove('active'));b.classList.add('active');currentSecao=b.dataset.secao;fetchProducts()}));
        filterButtons.forEach(b=>b.addEventListener('click',()=>{filterButtons.forEach(bt=>bt.classList.remove('active'));b.classList.add('active');currentFilter=b.dataset.filter;fetchProducts()}));

        document.addEventListener('DOMContentLoaded',()=>{fetchProducts();updateCartIcon();fetchSiteConfig();checkPushPermission()});
    </script>
</body>
</html>

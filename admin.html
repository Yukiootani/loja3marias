<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | 3 Marias Moda Feminina</title>
    <style>
        :root {
            --primary-color: #b76e86;
            --accent-color: #DAA520;
            --text-color: #333;
            --bg-color: #fdf7f9;
            --border-color: #e0e0e0;
            --error-color: #dc3545;
        }
        body { font-family: Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        h1, h2 { color: var(--primary-color); text-align: center; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; }
        form { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; padding: 20px; background: #fdf7f9; border-radius: 5px; }
        label { font-weight: bold; margin-bottom: -10px; }
        input[type="text"], input[type="number"], textarea, select, input[type="file"], input[type="password"], input[type="email"] {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box;
        }
        textarea { min-height: 100px; }
        button {
            background-color: var(--primary-color); color: white; padding: 12px; border: none; border-radius: 4px; font-size: 1em; font-weight: bold; cursor: pointer;
        }
        /* ðŸš¨ DIV DE STATUS CORRIGIDA */
        #status, #loginStatus { text-align: center; font-weight: bold; padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; }
        .success { background-color: #e6f9e6; color: #28a745; }
        .error { background-color: #fdeeee; color: var(--error-color); }
        .loading { background-color: #e6f2ff; color: #007bff; }
        
        /* Tabela de Gerenciamento */
        #products-table-container { overflow-x: auto; }
        #products-table { width: 100%; border-collapse: collapse; }
        #products-table th, #products-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        #products-table th { background-color: #f9f2f4; }
        #products-table img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .delete-btn { background-color: var(--error-color); font-size: 0.8em; padding: 5px 8px; }
        .edit-btn { background-color: var(--accent-color); color: #333; font-size: 0.8em; padding: 5px 8px; }
        
        /* Estilo das Variantes */
        #variants-container { border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; background: #fff; }
        .variant-entry { border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .variant-entry:last-child { border-bottom: none; }
        .variant-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .variant-row label { font-weight: normal; margin: 0; }
        .variant-row select, .variant-row input[type="text"] { width: auto; min-width: 150px; }
        .size-checkboxes { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
        .remove-variant-btn { background: var(--error-color); width: auto; padding: 5px 8px; font-size: 0.8em; }
        #add-variant-btn { background: var(--accent-color); color: #333; width: auto; padding: 8px 12px; margin-top: 10px; }
        
        /* NOVO: Estilo de Login */
        #login-section { border-bottom: 2px solid var(--accent-color); margin-bottom: 20px; }
        #admin-panel { display: none; } /* Oculto por padrÃ£o */
        #btnLogout { background-color: #777; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Painel de AdministraÃ§Ã£o</h1>
        <h2>3 Marias Moda Feminina</h2>

        <section id="login-section">
            <h3>Login de Admin</h3>
            <form id="loginForm">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
                <label for="login-password">Senha:</label>
                <input type="password" id="login-password" required>
                <button type="submit" id="btnLogin">Entrar</button>
            </form>
            <div id="loginStatus" class="status"></div>
        </section>

        <section id="admin-panel">
            <div id="status"></div>

            <form id="product-form">
                <h3 id="form-title">1. Adicionar Novo Produto</h3>
                <input type="hidden" id="productId"> <label for="name">Nome do Produto:</label>
                <input type="text" id="name" required>

                <label for="price">PreÃ§o (Â¥):</label>
                <input type="number" id="price" required>

                <label for="description">DescriÃ§Ã£o:</label>
                <textarea id="description" rows="4"></textarea>

                <label>Variantes (Cores e Tamanhos):</label>
                <div id="variants-container">
                    </div>
                <button type="button" id="add-variant-btn">+ Adicionar Cor</button>

                <label for="estoque">Estoque (Total de PeÃ§as):</label>
                <input type="number" id="estoque" value="0" required>

                <label for="source">Disponibilidade:</label>
                <select id="source" required>
                    <option value="pronta-entrega">Pronta Entrega</option>
                    <option value="sob-encomenda">Sob Encomenda (3-5 dias)</option>
                </select>

                <label for="isFeatured">Selo:</label>
                <select id="isFeatured">
                    <option value="nenhum">Nenhum</option>
                    <option value="novo">âœ¨ Novidade</option>
                    <option value="destaque">ðŸ”¥ Destaque</option>
                </select>

                <label for="imageUrl">Imagem de Capa (Upload):</label>
                <input type="file" id="imageUrl" accept="image/png, image/jpeg">
                
                <label for="videoUrl">VÃ­deo (Upload Opcional):</label>
                <input type="file" id="videoUrl" accept="video/mp4, video/webm">

                <label for="galeria">Galeria (Upload MÃºltiplo):</label>
                <input type="file" id="galeria" multiple accept="image/png, image/jpeg">
                
                <button type="submit" id="save-btn">Salvar Produto</button>
                <button type="button" id="cancel-edit-btn" style="display:none; background-color: #777;">Cancelar EdiÃ§Ã£o</button>
            </form>

            <h2>2. Gerenciar Produtos Existentes</h2>
            <div id="products-table-container">
                <table id="products-table">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Nome</th>
                            <th>PreÃ§o (Â¥)</th>
                            <th>Estoque</th>
                            <th>Disponibilidade</th>
                            <th>Selo</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="products-list">
                        </tbody>
                </table>
            </div>
            
            <button id="btnLogout">Sair (Logout)</button>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 

    <script>
        // ðŸš¨ CHAVES CORRETAS DA LOJA 3 MARIAS ðŸš¨
        const firebaseConfig = {
            apiKey: "AIzaSyDtQK3dZKTqoTkXkwTUM2vkviVD41UoHpI",
            authDomain: "loja3marias-50204.firebaseapp.com",
            projectId: "loja3marias-50204",
            storageBucket: "loja3marias-50204.firebasestorage.app",
            messagingSenderId: "405330133487",
            appId: "1:405330133487:web:606de41211df52245f761a",
            measurementId: "G-TK877V6P0S"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const storage = firebase.storage(); 
        const auth = firebase.auth(); // ðŸš¨ INICIALIZA O AUTH

        document.addEventListener('DOMContentLoaded', () => {

            // Elementos do DOM
            const form = document.getElementById('product-form');
            const formTitle = document.getElementById('form-title');
            const statusDiv = document.getElementById('status');
            const productsList = document.getElementById('products-list');
            const productIdField = document.getElementById('productId');
            const saveBtn = document.getElementById('save-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const addVariantBtn = document.getElementById('add-variant-btn');
            const variantsContainer = document.getElementById('variants-container');

            // Elementos de Login
            const loginSection = document.getElementById('login-section');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('loginForm');
            const loginStatusDiv = document.getElementById('loginStatus');
            const btnLogout = document.getElementById('btnLogout');

            // Campos do formulÃ¡rio
            const nameField = document.getElementById('name');
            const priceField = document.getElementById('price');
            const descField = document.getElementById('description');
            const estoqueField = document.getElementById('estoque');
            const sourceField = document.getElementById('source');
            const isFeaturedField = document.getElementById('isFeatured');
            const imageUrlInput = document.getElementById('imageUrl');
            const videoUrlInput = document.getElementById('videoUrl');
            const galeriaInput = document.getElementById('galeria');

            let oldImageUrl = '';
            let oldVideoUrl = '';
            let oldGaleria = [];
            
            let statusTimeout; 

            function showStatus(div, message, type) {
                clearTimeout(statusTimeout); 
                div.textContent = String(message); // Garante que Ã© texto
                div.className = 'status ' + type;
                div.style.display = 'block'; // Garante que estÃ¡ visÃ­vel
                
                if (type !== 'loading') { 
                    statusTimeout = setTimeout(() => { 
                        div.textContent = ''; 
                        div.className = '';
                        div.style.display = 'none'; 
                    }, 4000);
                }
            }

            // --- LÃ“GICA DE UPLOAD ---
            async function uploadFile(file, path) {
                const storageRef = storage.ref(path);
                const uploadTask = await storageRef.put(file);
                return await uploadTask.ref.getDownloadURL();
            }

            // --- LÃ“GICA DE VARIANTES ---
            const predefinedColors = [
                { name: "Preto", value: "black" },
                { name: "Branco", value: "white" },
                { name: "Vermelho", value: "red" },
                { name: "Rosa", value: "#FFC0CB" },
                { name: "Azul", value: "blue" },
                { name: "Verde", value: "green" },
                { name: "Amarelo", value: "yellow" },
                { name: "Cinza", value: "gray" },
                { name: "Bege", value: "#F5F5DC" },
                { name: "Nude", value: "#E3BC9A" },
                { name: "Vinho", value: "#800000" },
                { name: "Oncinha", value: "tan" }
            ];

            addVariantBtn.addEventListener('click', () => {
                const entryId = Date.now();
                const variantEntry = document.createElement('div');
                variantEntry.className = 'variant-entry';
                variantEntry.id = `variant-${entryId}`;
                
                let colorOptions = predefinedColors.map(c => `<option value="${c.name}" style="background-color:${c.value}; color:${c.value === 'black' ? 'white' : 'black'};">${c.name}</option>`).join('');

                variantEntry.innerHTML = `
                    <div class="variant-row">
                        <select class="variant-color-select">
                            <option value="">Escolha uma cor...</option>
                            ${colorOptions}
                            <option value="custom">Outra (Personalizada)</option>
                        </select>
                        <input type="text" class="variant-color-custom" placeholder="Cor Personalizada" style="display:none;">
                    </div>
                    <div class="size-checkboxes">
                        <input type="checkbox" id="p-${entryId}" data-size="P"><label for="p-${entryId}">P</label>
                        <input type="checkbox" id="m-${entryId}" data-size="M"><label for="m-${entryId}">M</label>
                        <input type="checkbox" id="g-${entryId}" data-size="G"><label for="g-${entryId}">G</label>
                        <input type="checkbox" id="gg-${entryId}" data-size="GG"><label for="gg-${entryId}">GG</label>
                    </div>
                    <button type="button" class="remove-variant-btn" data-id="${entryId}">X</button>
                `;
                variantsContainer.appendChild(variantEntry);
                
                // Evento para mostrar/esconder o campo "Outra Cor"
                variantEntry.querySelector('.variant-color-select').addEventListener('change', function() {
                    const customInput = variantEntry.querySelector('.variant-color-custom');
                    customInput.style.display = (this.value === 'custom') ? 'block' : 'none';
                });
                
                // Evento para o botÃ£o de remover
                variantEntry.querySelector('.remove-variant-btn').addEventListener('click', function() {
                    document.getElementById(`variant-${this.dataset.id}`).remove();
                });
            });

            function getVariantsFromForm() {
                const variants = {};
                const entries = variantsContainer.querySelectorAll('.variant-entry');
                entries.forEach(entry => {
                    const select = entry.querySelector('.variant-color-select');
                    const custom = entry.querySelector('.variant-color-custom');
                    
                    let color = (select.value === 'custom') ? custom.value : select.value;
                    
                    if (color) {
                        const sizes = [];
                        entry.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                            sizes.push(cb.dataset.size);
                        });
                        variants[color] = sizes;
                    }
                });
                return variants;
            }

            function setVariantsInForm(variants) {
                variantsContainer.innerHTML = ''; // Limpa
                if (!variants || Object.keys(variants).length === 0) return;

                for (const color in variants) {
                    const sizes = variants[color];
                    const entryId = Date.now() + Math.random();
                    const variantEntry = document.createElement('div');
                    variantEntry.className = 'variant-entry';
                    variantEntry.id = `variant-${entryId}`;
                    
                    let colorOptions = predefinedColors.map(c => `<option value="${c.name}" style="background-color:${c.value}; color:${c.value === 'black' ? 'white' : 'black'};">${c.name}</option>`).join('');
                    let isCustom = !predefinedColors.find(c => c.name === color);
                    let customValue = isCustom ? color : '';
                    let selectValue = isCustom ? 'custom' : color;
                    
                    const checkedP = sizes.includes('P') ? 'checked' : '';
                    const checkedM = sizes.includes('M') ? 'checked' : '';
                    const checkedG = sizes.includes('G') ? 'checked' : '';
                    const checkedGG = sizes.includes('GG') ? 'checked' : '';

                    variantEntry.innerHTML = `
                        <div class="variant-row">
                             <select class="variant-color-select">
                                <option value="">Escolha uma cor...</option>
                                ${colorOptions}
                                <option value="custom">Outra (Personalizada)</option>
                            </select>
                            <input type="text" class="variant-color-custom" value="${customValue}" style="display:${isCustom ? 'block' : 'none'};">
                        </div>
                        <div class="size-checkboxes">
                            <input type="checkbox" id="p-${entryId}" data-size="P" ${checkedP}><label for="p-${entryId}">P</label>
                            <input type="checkbox" id="m-${entryId}" data-size="M" ${checkedM}><label for="m-${entryId}">M</label>
                            <input type="checkbox" id="g-${entryId}" data-size="G" ${checkedG}><label for="g-${entryId}">G</label>
                            <input type="checkbox" id="gg-${entryId}" data-size="GG" ${checkedGG}><label for="gg-${entryId}">GG</label>
                        </div>
                        <button type="button" class="remove-variant-btn" data-id="${entryId}">X</button>
                    `;
                    variantsContainer.appendChild(variantEntry);
                    
                    // Define o valor selecionado
                    variantEntry.querySelector('.variant-color-select').value = selectValue;
                    
                    // Adiciona os eventos novamente
                    variantEntry.querySelector('.variant-color-select').addEventListener('change', function() {
                        const customInput = variantEntry.querySelector('.variant-color-custom');
                        customInput.style.display = (this.value === 'custom') ? 'block' : 'none';
                    });
                    variantEntry.querySelector('.remove-variant-btn').addEventListener('click', function() {
                        document.getElementById(`variant-${this.dataset.id}`).remove();
                    });
                }
            }


            // 1. CARREGAR PRODUTOS (READ)
            async function fetchProducts() {
                try {
                    productsList.innerHTML = '<tr><td colspan="7">Carregando produtos...</td></tr>';
                    const snapshot = await db.collection("products").orderBy("createdAt", "desc").get();
                    
                    if (snapshot.empty) {
                        productsList.innerHTML = '<tr><td colspan="7">Nenhum produto cadastrado ainda.</td></tr>';
                        return;
                    }
                    
                    let html = '';
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const id = doc.id;
                        const precoFormatado = (product.price || 0).toLocaleString('ja-JP');
                        
                        html += `
                            <tr id="product-${id}">
                                <td><img src="${product.imageUrl || 'https://via.placeholder.com/50'}" alt="${product.name}"></td>
                                <td>${product.name || 'Sem nome'}</td>
                                <td>Â¥${precoFormatado}</td>
                                <td>${product.estoque || 0}</td>
                                <td>${product.source === 'pronta-entrega' ? 'Pronta Entrega' : 'Sob Encomenda'}</td>
                                <td>${product.isFeatured || 'nenhum'}</td>
                                <td>
                                    <button class="edit-btn" data-id="${id}">Editar</button>
                                    <button class="delete-btn" data-id="${id}">Excluir</button>
                                </td>
                            </tr>
                        `;
                    });
                    productsList.innerHTML = html;
                } catch (error) {
                    console.error("Erro ao carregar produtos:", error);
                    showStatus(statusDiv, "Erro ao carregar produtos: " + String(error.message), "error");
                }
            }

            // 2. SALVAR/ATUALIZAR PRODUTO (CREATE/UPDATE)
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveBtn.disabled = true;
                showStatus(statusDiv, "Salvando... Por favor, aguarde o upload.", "loading");

                const currentProductId = productIdField.value || `pid_${Date.now()}`;
                
                try {
                    let imageUrl = oldImageUrl;
                    let videoUrl = oldVideoUrl;
                    let galeriaUrls = oldGaleria;
                    
                    // UPLOAD IMAGEM DE CAPA
                    if (imageUrlInput.files[0]) {
                        showStatus(statusDiv, "Fazendo upload da Imagem de Capa (1/3)...", "loading");
                        const file = imageUrlInput.files[0];
                        const path = `products/${currentProductId}/capa_${file.name}`;
                        imageUrl = await uploadFile(file, path);
                    }

                    // UPLOAD VÃDEO
                    if (videoUrlInput.files[0]) {
                        showStatus(statusDiv, "Fazendo upload do VÃ­deo (2/3)...", "loading");
                        const file = videoUrlInput.files[0];
                        const path = `products/${currentProductId}/video_${file.name}`;
                        videoUrl = await uploadFile(file, path);
                    }
                    
                    // UPLOAD GALERIA (MÃºltiplos)
                    if (galeriaInput.files.length > 0) {
                        showStatus(statusDiv, `Fazendo upload de ${galeriaInput.files.length} imagens da galeria (3/3)...`, "loading");
                        galeriaUrls = []; // Reseta a galeria se novos arquivos forem enviados
                        for (const file of galeriaInput.files) {
                            const path = `products/${currentProductId}/galeria_${file.name}`;
                            const url = await uploadFile(file, path);
                            galeriaUrls.push(url);
                        }
                    }
                    
                    const productData = {
                        name: nameField.value,
                        price: parseFloat(priceField.value),
                        description: descField.value,
                        variantes: getVariantsFromForm(), // NOVO
                        estoque: parseInt(estoqueField.value),
                        source: sourceField.value,
                        isFeatured: isFeaturedField.value,
                        imageUrl: imageUrl,
                        videoUrl: videoUrl,
                        galeria: galeriaUrls
                    };

                    if (productIdField.value) {
                        // Atualizar (Update)
                        showStatus(statusDiv, "Atualizando produto no banco de dados...", "loading");
                        await db.collection("products").doc(currentProductId).update(productData);
                        showStatus("Produto atualizado com sucesso!", "success");
                    } else {
                        // Criar (Create)
                        showStatus(statusDiv, "Criando produto no banco de dados...", "loading");
                        productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection("products").doc(currentProductId).set(productData);
                        showStatus("Produto salvo com sucesso!", "success");
                    }
                    
                    cancelEditMode(); 
                    fetchProducts(); // Recarrega a lista
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    showStatus(statusDiv, "Erro ao salvar: " + String(error.message), "error");
                } finally {
                    saveBtn.disabled = false;
                }
            });

            // 3. EXCLUIR E EDITAR (Event Delegation)
            productsList.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;

                if (target.classList.contains('delete-btn')) {
                    // Excluir
                    if (!confirm("Tem certeza que deseja excluir este produto?")) return;
                    try {
                        await db.collection("products").doc(id).delete();
                        showStatus(statusDiv, "Produto excluÃ­do com sucesso!", "success");
                        fetchProducts(); // Recarrega a lista
                    } catch (error) {
                        console.error("Erro ao excluir:", error);
                        showStatus(statusDiv, "Erro ao excluir: " + String(error.message), "error");
                    }
                }
                
                if (target.classList.contains('edit-btn')) {
                    // Editar
                    try {
                        const doc = await db.collection("products").doc(id).get();
                        if (!doc.exists) {
                            showStatus(statusDiv, "Erro: Produto nÃ£o encontrado.", "error");
                            return;
                        }
                        const product = doc.data();
                        
                        productIdField.value = id;
                        nameField.value = product.name || '';
                        priceField.value = product.price || 0;
                        descField.value = product.description || '';
                        
                        setVariantsInForm(product.variantes || {});
                        
                        estoqueField.value = product.estoque || 0;
                        sourceField.value = product.source || 'pronta-entrega';
                        isFeaturedField.value = product.isFeatured || 'nenhum';
                        
                        oldImageUrl = product.imageUrl || '';
                        oldVideoUrl = product.videoUrl || '';
                        oldGaleria = product.galeria || [];
                        
                        imageUrlInput.value = '';
                        videoUrlInput.value = '';
                        galeriaInput.value = '';

                        formTitle.textContent = "2. Editando Produto";
                        saveBtn.textContent = "Atualizar Produto";
                        cancelEditBtn.style.display = "block";
                        window.scrollTo(0, 0); // Rola para o topo
                    } catch (error) {
                        showStatus(statusDiv, "Erro ao carregar para ediÃ§Ã£o: " + String(error.message), "error");
                    }
                }
            });

            // 5. Cancelar EdiÃ§Ã£o
            cancelEditBtn.addEventListener('click', cancelEditMode);
            function cancelEditMode() {
                productIdField.value = '';
                form.reset();
                variantsContainer.innerHTML = ''; // Limpa as variantes
                oldImageUrl = ''; oldVideoUrl = ''; oldGaleria = [];
                
                formTitle.textContent = "1. Adicionar Novo Produto";
                saveBtn.textContent = "Salvar Produto";
                cancelEditBtn.style.display = "none";
            }

            // --- LÃ“GICA DE LOGIN ---
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                showStatus(loginStatusDiv, 'Tentando entrar...', 'loading');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // O onAuthStateChanged vai tratar de mostrar o painel
                } catch (error) {
                    showStatus(loginStatusDiv, `Erro de Acesso: ${error.message}`, 'error');
                }
            });

            btnLogout.addEventListener('click', async () => {
                await auth.signOut();
            });

            // VerificaÃ§Ã£o de Estado de AutenticaÃ§Ã£o
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // UsuÃ¡rio LOGADO
                    loginSection.style.display = 'none';
                    adminPanel.style.display = 'block';
                    fetchProducts(); // Carrega os produtos
                } else {
                    // UsuÃ¡rio DESLOGADO
                    loginSection.style.display = 'block';
                    adminPanel.style.display = 'none';
                }
            });
        
        }); // FIM DO DOMCONTENTLOADED
    </script>

</body>
</html>
